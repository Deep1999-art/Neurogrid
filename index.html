<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>NeuroGrid ‚Äî Brain Training Game</title>
<meta name="description" content="NeuroGrid: Pattern recognition and memory brain training game by NeuroGrid Ltd"/>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6536942495941261" crossorigin="anonymous"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap" rel="stylesheet"/>
<style>
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
  html,body{height:100%;overflow:hidden;background:#060912;}
  body{font-family:'Rajdhani',sans-serif;color:#e0e8ff;touch-action:manipulation;}
  #root{height:100%;}
  .ng-root{
    min-height:100vh;min-height:100dvh;
    background:radial-gradient(ellipse at 20% 20%,#0d1f3c 0%,#060912 60%),
               radial-gradient(ellipse at 80% 80%,#1a0830 0%,transparent 60%);
    display:flex;align-items:center;justify-content:center;padding:20px;
  }
  .wrap{width:100%;max-width:460px;}
  .orb{font-family:'Orbitron',monospace;}
  .shake{animation:shake .4s ease;}
  @keyframes shake{0%,100%{transform:translateX(0);}20%{transform:translateX(-8px);}40%{transform:translateX(8px);}60%{transform:translateX(-5px);}80%{transform:translateX(5px);}}
  .pulse{animation:pulse 1.2s ease infinite;}
  @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.35;}}
  .beat{animation:beat 1s ease infinite;}
  @keyframes beat{0%,100%{transform:scale(1);}50%{transform:scale(1.04);}}
  .fadein{animation:fadein .35s ease;}
  @keyframes fadein{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
  .gbtn{
    background:linear-gradient(135deg,#4CC9F0 0%,#7B2FBE 100%);
    border:none;border-radius:10px;color:#fff;
    font-family:'Orbitron',monospace;font-size:12px;font-weight:700;
    padding:13px 28px;cursor:pointer;letter-spacing:2px;
    box-shadow:0 0 30px rgba(76,201,240,.4);transition:all .2s;
    -webkit-appearance:none;
  }
  .gbtn:hover{transform:translateY(-2px);box-shadow:0 0 50px rgba(76,201,240,.7);}
  .gbtn:active{transform:scale(.97);}
  .gbtn:disabled{opacity:.45;cursor:not-allowed;transform:none;}
  .gbtn-gold{background:linear-gradient(135deg,#FFD166,#FF9500)!important;color:#1a0a00!important;box-shadow:0 0 30px rgba(255,209,102,.4)!important;}
  .gbtn-gold:hover{box-shadow:0 0 50px rgba(255,209,102,.7)!important;}
  .gbtn-outline{background:rgba(255,255,255,.06)!important;box-shadow:none!important;border:1px solid rgba(255,255,255,.15)!important;}
  .gbtn-green{background:linear-gradient(135deg,#7BFF72,#00C853)!important;color:#001a00!important;box-shadow:0 0 30px rgba(123,255,114,.4)!important;}
  .tbar{height:6px;border-radius:3px;background:rgba(255,255,255,.08);overflow:hidden;margin-bottom:14px;}
  .tfill{height:100%;border-radius:3px;transition:width .1s linear,background .5s;}
  .cbar{height:8px;border-radius:4px;background:rgba(255,255,255,.08);overflow:hidden;}
  .cfill{height:100%;border-radius:4px;background:linear-gradient(90deg,#4CC9F0,#C77DFF);transition:width .5s ease;box-shadow:0 0 10px rgba(76,201,240,.6);}
  .scard{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px 16px;text-align:center;}
  .grid{display:grid;gap:6px;}
  .gcell{border-radius:12px;border:2px solid rgba(255,255,255,.07);background:rgba(255,255,255,.03);
         display:flex;align-items:center;justify-content:center;cursor:pointer;
         transition:all .14s ease;aspect-ratio:1;user-select:none;}
  .gcell:hover{border-color:rgba(255,255,255,.22)!important;background:rgba(255,255,255,.07)!important;}
  .gcell:active{transform:scale(.91)!important;}
  .overlay{position:fixed;inset:0;background:rgba(6,9,18,.93);display:flex;align-items:center;justify-content:center;z-index:200;padding:20px;}
  .modal{background:linear-gradient(160deg,#0d1a30,#120820);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:28px 22px;max-width:340px;width:100%;text-align:center;}
  .ad-bar{height:4px;border-radius:2px;background:rgba(255,255,255,.1);overflow:hidden;margin:14px 0;}
  .ad-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,#4CC9F0,#C77DFF);}
  .lvl-bar{height:3px;background:rgba(255,255,255,.06);border-radius:2px;overflow:hidden;margin-bottom:4px;}
  .lvl-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,#4CC9F0,#C77DFF);transition:width .5s;}
  .free-badge{display:inline-flex;align-items:center;gap:4px;background:rgba(123,255,114,.1);border:1px solid rgba(123,255,114,.3);border-radius:12px;padding:3px 11px;font-size:10px;color:#7BFF72;font-family:'Orbitron',monospace;}
  .unlock-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(255,209,102,.1);border:1px solid rgba(255,209,102,.3);border-radius:20px;padding:4px 12px;font-size:11px;color:#FFD166;margin-bottom:14px;}
  .audio-ctrl{position:fixed;top:14px;right:14px;z-index:99;display:flex;gap:8px;}
  .ibtn{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:8px;color:#fff;font-size:16px;width:36px;height:36px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
  .spin{animation:spin .9s linear infinite;display:inline-block;}
  @keyframes spin{to{transform:rotate(360deg);}}
  .hearts{display:flex;gap:4px;}
  .heart{font-size:20px;transition:opacity .3s;}
  @media(max-width:380px){.orb.title{font-size:40px!important;}}
</style>
</head>
<body>
<div id="root"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GRID_SIZE = 5;
const BASE_TIME = 8000;
const FREE_LEVEL_LIMIT = 10;
const UNLOCK_PRICE_LABEL = "$2.99";
const GLOW = ["#FF4D6D","#4CC9F0","#7BFF72","#FFD166","#C77DFF"];
const BG   = ["rgba(255,77,109,.18)","rgba(76,201,240,.18)","rgba(123,255,114,.18)","rgba(255,209,102,.18)","rgba(199,125,255,.18)"];

// ‚îÄ‚îÄ MONETIZATION (mock ‚Äî replace with real SDKs for production) ‚îÄ‚îÄ
const Monetization = {
  showRewardedAd:(onRewarded,onFailed)=>{
    setTimeout(()=>{ Math.random()>.05?onRewarded():onFailed(); },3000);
  },
  purchaseUnlock:(onSuccess)=>{ setTimeout(onSuccess,1800); },
  restorePurchases:(_,onNone)=>{ setTimeout(onNone,1200); },
  track:(e,p={})=>{ console.log('[Analytics]',e,p); }
};

// ‚îÄ‚îÄ AUDIO ENGINE (100% original ‚Äî Web Audio API) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class NeuroAudio {
  constructor(){this.ctx=null;this.mg=null;this.sg=null;this.musg=null;this.nodes=[];this.playing=false;this.muted=false;this.musicMuted=false;this._ref=null;}
  init(){
    if(this.ctx)return;
    this.ctx=new(window.AudioContext||window.webkitAudioContext)();
    this.mg=this.ctx.createGain();this.mg.gain.value=1;this.mg.connect(this.ctx.destination);
    this.musg=this.ctx.createGain();this.musg.gain.value=.2;this.musg.connect(this.mg);
    this.sg=this.ctx.createGain();this.sg.gain.value=.7;this.sg.connect(this.mg);
  }
  resume(){this.ctx?.state==='suspended'&&this.ctx.resume();}
  _o(f,t,s,d,v,dest){
    const o=this.ctx.createOscillator(),g=this.ctx.createGain(),dst=dest||this.sg;
    o.type=t;o.frequency.value=f;
    g.gain.setValueAtTime(0,s);g.gain.linearRampToValueAtTime(v,s+.012);g.gain.exponentialRampToValueAtTime(.001,s+d);
    o.connect(g);g.connect(dst);o.start(s);o.stop(s+d+.05);return o;
  }
  _n(s,d,v,ff,ft,dest){
    const dst=dest||this.sg,bLen=Math.floor(this.ctx.sampleRate*d),buf=this.ctx.createBuffer(1,bLen,this.ctx.sampleRate);
    const dat=buf.getChannelData(0);for(let i=0;i<bLen;i++)dat[i]=(Math.random()*2-1)*Math.exp(-i/(bLen*.4));
    const src=this.ctx.createBufferSource(),g=this.ctx.createGain(),flt=this.ctx.createBiquadFilter();
    flt.type=ft||'bandpass';flt.frequency.value=ff||1500;
    g.gain.setValueAtTime(v,s);g.gain.exponentialRampToValueAtTime(.001,s+d);
    src.buffer=buf;src.connect(flt);flt.connect(g);g.connect(dst);src.start(s);return src;
  }
  playTap(ci){if(!this.ctx||this.muted)return;this.resume();const n=this.ctx.currentTime,f=[523.25,587.33,659.25,783.99,880][ci%5];this._o(f,'sine',n,.28,.55);this._o(f*2,'sine',n,.12,.18);this._n(n,.04,.12,4000,'highpass');}
  playSuccess(){if(!this.ctx||this.muted)return;this.resume();const n=this.ctx.currentTime;[523.25,659.25,783.99,1046.5].forEach((f,i)=>{this._o(f,'sine',n+i*.08,.5,.45);this._o(f,'triangle',n+i*.08,.4,.15);});for(let i=0;i<5;i++)this._o(1200+Math.random()*1800,'sine',n+Math.random()*.3,.25,.07);}
  playWrong(){if(!this.ctx||this.muted)return;this.resume();const n=this.ctx.currentTime;this._o(160,'sawtooth',n,.22,.45);this._o(165,'sawtooth',n,.22,.3);this._o(80,'square',n,.18,.2);this._n(n,.15,.25,600,'bandpass');}
  playTimeout(){if(!this.ctx||this.muted)return;this.resume();const n=this.ctx.currentTime;[440,349.23,293.66,220].forEach((f,i)=>this._o(f,'sine',n+i*.14,.38,.38));}
  playGameOver(){if(!this.ctx||this.muted)return;this.resume();const n=this.ctx.currentTime;this._o(110,'sawtooth',n,1.2,.5);this._o(55,'sine',n,1.5,.55);this._n(n,.8,.3,300,'lowpass');}
  playLevelUp(){if(!this.ctx||this.muted)return;this.resume();const n=this.ctx.currentTime;[392,523.25,659.25,784,1046.5].forEach((f,i)=>{this._o(f,'triangle',n+i*.07,.4,.42);this._o(f*1.5,'sine',n+i*.07,.18,.1);});}
  playPurchase(){if(!this.ctx||this.muted)return;this.resume();const n=this.ctx.currentTime;[523.25,659.25,783.99,1046.5,1318.5].forEach((f,i)=>{this._o(f,'sine',n+i*.06,.6,.5);this._o(f*2,'sine',n+i*.06,.3,.1);});for(let i=0;i<8;i++)this._o(1500+Math.random()*2000,'sine',n+Math.random()*.4,.2,.06);}
  playStudyStart(){if(!this.ctx||this.muted)return;this.resume();const n=this.ctx.currentTime;this._o(880,'sine',n,.55,.32);this._o(1320,'sine',n+.1,.4,.18);this._o(1760,'sine',n+.2,.28,.1);}
  playTick(last){if(!this.ctx||this.muted)return;this.resume();this._o(last?1200:800,'sine',this.ctx.currentTime,.07,last?.5:.28);}
  playClick(){if(!this.ctx||this.muted)return;this.resume();const n=this.ctx.currentTime;this._o(600,'sine',n,.06,.28);this._o(900,'sine',n+.02,.05,.12);}
  startMusic(){if(!this.ctx||this.playing||this.musicMuted)return;this.resume();this.playing=true;this._loop();}
  stopMusic(){this.playing=false;clearTimeout(this._ref);this.nodes.forEach(n=>{try{n.stop();}catch(e){}});this.nodes=[];}
  _loop(){
    if(!this.playing)return;
    const ctx=this.ctx,mg=this.musg,now=ctx.currentTime+.05,beat=60/118,bar=beat*4,loop=bar*4;
    const o=(f,t,s,d,v,det)=>{const osc=ctx.createOscillator(),g=ctx.createGain();osc.type=t;osc.frequency.value=f;if(det)osc.detune.value=det;g.gain.setValueAtTime(0,now+s);g.gain.linearRampToValueAtTime(v,now+s+.015);g.gain.exponentialRampToValueAtTime(.001,now+s+d);osc.connect(g);g.connect(mg);osc.start(now+s);osc.stop(now+s+d+.05);this.nodes.push(osc);};
    const n=(s,d,v,ff,ft)=>{const bLen=Math.floor(ctx.sampleRate*d),buf=ctx.createBuffer(1,bLen,ctx.sampleRate),dat=buf.getChannelData(0);for(let i=0;i<bLen;i++)dat[i]=(Math.random()*2-1)*Math.exp(-i/(bLen*.35));const src=ctx.createBufferSource(),g=ctx.createGain(),f=ctx.createBiquadFilter();f.type=ft;f.frequency.value=ff;g.gain.setValueAtTime(v,now+s);g.gain.exponentialRampToValueAtTime(.001,now+s+d);src.buffer=buf;src.connect(f);f.connect(g);g.connect(mg);src.start(now+s);this.nodes.push(src);};
    [0,beat*2,bar,bar+beat*2,bar*2,bar*2+beat*2,bar*3,bar*3+beat*3].forEach(s=>{const osc=ctx.createOscillator(),g=ctx.createGain();osc.type='sine';osc.frequency.setValueAtTime(160,now+s);osc.frequency.exponentialRampToValueAtTime(38,now+s+.16);g.gain.setValueAtTime(.9,now+s);g.gain.exponentialRampToValueAtTime(.001,now+s+.28);osc.connect(g);g.connect(mg);osc.start(now+s);osc.stop(now+s+.3);this.nodes.push(osc);});
    [beat,beat*3,bar+beat,bar+beat*3,bar*2+beat,bar*2+beat*3,bar*3+beat,bar*3+beat*3].forEach(s=>{n(s,.13,.5,1500,'bandpass');o(210,'triangle',s,.1,.22);});
    for(let i=0;i<32;i++)n(i*beat*.5,.035,i%4===0?.3:i%2===0?.16:.08,9000,'highpass');
    [[0,65.41],[beat*1.5,65.41],[beat*2,73.42],[beat*3,82.41],[bar+beat,55],[bar+beat*3,65.41],[bar*2,65.41],[bar*2+beat*2,73.42],[bar*3,87.31],[bar*3+beat*2.5,65.41]].forEach(([s,f])=>{const osc=ctx.createOscillator(),g=ctx.createGain(),flt=ctx.createBiquadFilter();flt.type='lowpass';flt.frequency.value=220;osc.type='sawtooth';osc.frequency.value=f;g.gain.setValueAtTime(0,now+s);g.gain.linearRampToValueAtTime(.55,now+s+.01);g.gain.exponentialRampToValueAtTime(.001,now+s+beat*.75);osc.connect(flt);flt.connect(g);g.connect(mg);osc.start(now+s);osc.stop(now+s+beat);this.nodes.push(osc);});
    [[0,[261.63,329.63,392]],[bar,[220,261.63,329.63]],[bar*2,[261.63,329.63,392]],[bar*3,[174.61,220,261.63]]].forEach(([s,fs])=>fs.forEach(f=>{o(f,'sine',s,bar,.13);o(f,'triangle',s,bar,.06,7);}));
    [523.25,587.33,659.25,783.99,880,1046.5,880,783.99].forEach((f,i)=>o(f,'triangle',i*beat*.5,beat*.38,.17));
    [440,523.25,659.25,783.99,880,1046.5,783.99,659.25].forEach((f,i)=>o(f,'triangle',bar*2+i*beat*.5,beat*.38,.17));
    [523.25,587.33,659.25,783.99,880,1046.5,880,783.99].forEach((f,i)=>o(f,'sine',bar+i*beat*.5,beat*.3,.08));
    this._ref=setTimeout(()=>{this.nodes=[];if(this.playing)this._loop();},loop*1000-50);
  }
  toggleMute(){this.muted=!this.muted;this.musicMuted=this.muted;this.mg.gain.value=this.muted?0:1;if(this.muted)this.stopMusic();return this.muted;}
  toggleMusic(){this.musicMuted=!this.musicMuted;if(this.musicMuted)this.stopMusic();else{this.playing=false;this.startMusic();}return this.musicMuted;}
}
const audio=new NeuroAudio();

// ‚îÄ‚îÄ PATTERN GENERATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function genPattern(level){
  const len=Math.min(3+Math.floor(level/2),7),total=GRID_SIZE*GRID_SIZE;
  const cells=Array(total).fill(null).map((_,i)=>({id:i,ci:Math.floor(Math.random()*5),isP:false}));
  const idx=[];
  while(idx.length<len){const i=Math.floor(Math.random()*total);if(!idx.includes(i))idx.push(i);}
  idx.forEach((i,n)=>{cells[i].isP=true;cells[i].ci=n%5;cells[i].ord=n;});
  return{cells,idx,len};
}

// ‚îÄ‚îÄ GAME COMPONENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function NeuroGrid(){
  const [scr,setScr]=useState('menu');
  const [level,setLevel]=useState(1);
  const [score,setScore]=useState(0);
  const [lives,setLives]=useState(3);
  const [pat,setPat]=useState(null);
  const [sel,setSel]=useState([]);
  const [tLeft,setTLeft]=useState(100);
  const [msg,setMsg]=useState('');
  const [cog,setCog]=useState(0);
  const [studyT,setStudyT]=useState(3);
  const [streak,setStreak]=useState(0);
  const [best,setBest]=useState(0);
  const [shake,setShake]=useState(false);
  const [flash,setFlash]=useState(null);
  const [muted,setMuted]=useState(false);
  const [musicMuted,setMusicMuted]=useState(false);
  const [aReady,setAReady]=useState(false);
  const [unlocked,setUnlocked]=useState(false);
  const [showPay,setShowPay]=useState(false);
  const [showAd,setShowAd]=useState(false);
  const [adType,setAdType]=useState(null);
  const [adWatch,setAdWatch]=useState(false);
  const [adT,setAdT]=useState(0);
  const [adFail,setAdFail]=useState(false);
  const [buying,setBuying]=useState(false);
  const [buyOk,setBuyOk]=useState(false);
  const [contUsed,setContUsed]=useState(false);
  const [restoring,setRestoring]=useState(false);
  const tRef=useRef(null),sRef=useRef(null),adRef=useRef(null);

  const initA=useCallback(()=>{if(!aReady){audio.init();setAReady(true);}}, [aReady]);

  const startLevel=useCallback((lvl)=>{
    const p=genPattern(lvl);setPat(p);setSel([]);
    setStudyT(Math.max(2,4-Math.floor(lvl/3)));
    setScr('study');setMsg('');
    audio.playStudyStart();
    if(!audio.playing&&!audio.musicMuted)audio.startMusic();
    Monetization.track('level_start',{level:lvl});
  },[]);

  useEffect(()=>{
    if(scr!=='study')return;
    let t=Math.max(2,4-Math.floor(level/3));setStudyT(t);
    sRef.current=setInterval(()=>{t--;setStudyT(t);if(t>0)audio.playTick(t===1);if(t<=0){clearInterval(sRef.current);setScr('play');setTLeft(100);}},1000);
    return()=>clearInterval(sRef.current);
  },[scr,level]);

  useEffect(()=>{
    if(scr!=='play')return;
    const dur=Math.max(5000,BASE_TIME-level*300);let el=0;
    tRef.current=setInterval(()=>{el+=100;setTLeft(Math.max(0,100-(el/dur)*100));if(el>=dur){clearInterval(tRef.current);doTimeout();}},100);
    return()=>clearInterval(tRef.current);
  },[scr,level]);

  const doTimeout=()=>{
    audio.playTimeout();
    setLives(l=>{const nl=l-1;if(nl<=0){audio.playGameOver();audio.stopMusic();setScr('gameover');}else{setMsg('‚è∞ Time\'s up!');setStreak(0);setTimeout(()=>startLevel(level),1500);}return nl;});
  };

  const cellClick=(id)=>{
    if(scr!=='play'||!pat)return;initA();
    const cell=pat.cells[id],exp=pat.idx[sel.length];
    setFlash(id);setTimeout(()=>setFlash(null),180);
    if(id===exp){
      audio.playTap(cell.ci);const ns=[...sel,id];setSel(ns);
      if(ns.length===pat.len){
        clearInterval(tRef.current);
        const g=100+Math.floor(tLeft)+streak*10,ns2=score+g,nst=streak+1;
        setScore(ns2);setStreak(nst);setCog(c=>Math.min(100,c+5));setBest(b=>Math.max(b,ns2));
        setMsg(`‚ú® +${g} pts  |  üî• Streak ${nst}`);
        if(nst%3===0)audio.playLevelUp();else audio.playSuccess();
        setScr('result');Monetization.track('level_complete',{level,score:ns2});
      }
    } else {
      audio.playWrong();setShake(true);setTimeout(()=>setShake(false),500);
      setLives(l=>{const nl=l-1;if(nl<=0){clearInterval(tRef.current);audio.playGameOver();audio.stopMusic();setScr('gameover');}else{setSel([]);setMsg('‚ùå Wrong! Try again.');}return nl;});
    }
  };

  const tryNext=()=>{
    audio.playClick();const nx=level+1;
    if(nx>FREE_LEVEL_LIMIT&&!unlocked){setShowPay(true);Monetization.track('paywall_shown',{trigger:'level_gate'});}
    else{setLevel(nx);startLevel(nx);}
  };

  const triggerAd=(type)=>{initA();audio.playClick();setAdType(type);setAdFail(false);setAdWatch(false);setAdT(5);setShowAd(true);};

  const watchAd=()=>{
    setAdWatch(true);let t=5;
    adRef.current=setInterval(()=>{t--;setAdT(t);
      if(t<=0){clearInterval(adRef.current);
        Monetization.showRewardedAd(()=>{
          setShowAd(false);setAdWatch(false);
          if(adType==='continue'){setLives(3);setContUsed(true);setSel([]);setMsg('‚ñ∂Ô∏è Continue!');startLevel(level);}
          else if(adType==='hint'){setScr('study');setMsg('üí° Pattern revealed for 2s!');setTimeout(()=>{setScr('play');},2000);}
        },()=>{setAdFail(true);setAdWatch(false);clearInterval(adRef.current);});
      }
    },1000);
  };

  const doPurchase=()=>{
    audio.playClick();setBuying(true);
    Monetization.purchaseUnlock(()=>{setUnlocked(true);setBuying(false);setBuyOk(true);audio.playPurchase();
      setTimeout(()=>{setBuyOk(false);setShowPay(false);setLevel(level+1);startLevel(level+1);},2500);
    },()=>setBuying(false));
  };

  const doRestore=()=>{
    setRestoring(true);
    Monetization.restorePurchases(()=>{setUnlocked(true);setRestoring(false);setShowPay(false);},()=>setRestoring(false));
  };

  const startGame=()=>{initA();audio.playClick();setScore(0);setLives(3);setLevel(1);setStreak(0);setCog(0);setContUsed(false);startLevel(1);};
  const restart=()=>{audio.playClick();setLevel(1);setScore(0);setLives(3);setStreak(0);setCog(0);setContUsed(false);startLevel(1);};

  const cs=(cell,idx)=>{
    const isSel=sel.includes(idx),isFlash=flash===idx,isShow=cell.isP&&(scr==='study');
    const c=GLOW[cell.ci],bg=BG[cell.ci];
    return{borderColor:isShow||isSel?c:'rgba(255,255,255,.07)',background:isShow||isSel?bg:isFlash?'rgba(255,255,255,.14)':'rgba(255,255,255,.03)',boxShadow:isShow||isSel?`0 0 18px ${c}55,inset 0 0 10px ${c}22`:'none',transform:isFlash?'scale(.9)':'scale(1)'};
  };

  const Hearts=()=>Array(3).fill(0).map((_,i)=>(
    <span key={i} className="heart" style={{opacity:i<lives?1:.18,filter:i<lives?'drop-shadow(0 0 6px #FF4D6D)':'none'}}>‚ù§Ô∏è</span>
  ));

  return <>
    {/* Audio Controls */}
    <div className="audio-ctrl">
      <button className="ibtn" onClick={()=>{initA();setMusicMuted(audio.toggleMusic());}} title="Toggle Music">{musicMuted?'üéµ':'üé∂'}</button>
      <button className="ibtn" onClick={()=>{initA();setMuted(audio.toggleMute());setMusicMuted(audio.musicMuted);}} title="Toggle Sound">{muted?'üîá':'üîä'}</button>
      {unlocked&&<div className="ibtn" style={{cursor:'default',background:'rgba(255,209,102,.1)',border:'1px solid rgba(255,209,102,.3)',fontSize:14}} title="Full Game Unlocked">üëë</div>}
    </div>

    {/* Rewarded Ad Modal */}
    {showAd&&<div className="overlay">
      <div className="modal fadein">
        {!adWatch&&!adFail&&<>
          <div style={{fontSize:38,marginBottom:12}}>{adType==='continue'?'üíî‚û°Ô∏è‚ù§Ô∏è':'üí°'}</div>
          <div className="orb" style={{fontSize:15,fontWeight:900,color:'#4CC9F0',marginBottom:8}}>{adType==='continue'?'CONTINUE PLAYING':'REVEAL HINT'}</div>
          <div style={{fontSize:13,color:'#8899bb',marginBottom:20,lineHeight:1.6}}>{adType==='continue'?'Watch a short ad to restore 3 lives and continue.':'Watch a short ad to briefly reveal the pattern for 2 seconds.'}</div>
          <div style={{display:'flex',gap:10,justifyContent:'center'}}>
            <button className="gbtn gbtn-green" onClick={watchAd}>‚ñ∂ WATCH AD</button>
            <button className="gbtn gbtn-outline" onClick={()=>{setShowAd(false);if(adType==='continue'){audio.stopMusic();setScr('gameover');}}}>NO THANKS</button>
          </div>
        </>}
        {adWatch&&!adFail&&<>
          <div className="pulse" style={{fontSize:38,marginBottom:12}}>üì∫</div>
          <div className="orb" style={{fontSize:13,color:'#4CC9F0',marginBottom:6}}>AD PLAYING...</div>
          <div style={{fontSize:11,color:'#445566',marginBottom:14}}>Reward granted after completion.</div>
          <div className="ad-bar"><div className="ad-fill" style={{width:`${((5-adT)/5)*100}%`,transition:'width 1s linear'}}/></div>
          <div className="orb" style={{fontSize:22,color:'#FFD166'}}>{adT}s</div>
        </>}
        {adFail&&<>
          <div style={{fontSize:34,marginBottom:12}}>‚ö†Ô∏è</div>
          <div className="orb" style={{fontSize:13,color:'#FF4D6D',marginBottom:8}}>AD UNAVAILABLE</div>
          <div style={{fontSize:12,color:'#667799',marginBottom:18}}>No ad available right now. Try again later.</div>
          <button className="gbtn gbtn-outline" onClick={()=>setShowAd(false)}>CLOSE</button>
        </>}
      </div>
    </div>}

    {/* Paywall Modal */}
    {showPay&&<div className="overlay">
      <div className="modal fadein">
        {buyOk?<>
          <div style={{fontSize:48,marginBottom:12}}>üëë</div>
          <div className="orb" style={{fontSize:20,fontWeight:900,color:'#FFD166',marginBottom:8}}>UNLOCKED!</div>
          <div style={{fontSize:13,color:'#aabbd0'}}>Full game is yours. Enjoy every level!</div>
        </>:<>
          <div className="unlock-badge">üëë FULL GAME</div>
          <div className="orb" style={{fontSize:20,fontWeight:900,background:'linear-gradient(135deg,#FFD166,#FF9500)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',marginBottom:6}}>LEVEL {FREE_LEVEL_LIMIT+1}+</div>
          <div style={{fontSize:13,color:'#8899bb',marginBottom:18,lineHeight:1.7}}>You've completed all <strong style={{color:'#4CC9F0'}}>{FREE_LEVEL_LIMIT} free levels</strong>!<br/>Unlock unlimited levels, no ads ever.</div>
          <div style={{background:'rgba(255,255,255,.04)',borderRadius:12,padding:14,marginBottom:18,textAlign:'left'}}>
            {['‚ôæÔ∏è Unlimited levels','üö´ Remove all ads','üé® 3 exclusive themes','üß† Full cognitive history','üèÜ Daily challenge mode'].map(f=>(
              <div key={f} style={{fontSize:12,color:'#aabbd0',padding:'4px 0',borderBottom:'1px solid rgba(255,255,255,.05)'}}>{f}</div>
            ))}
          </div>
          <button className="gbtn gbtn-gold" style={{width:'100%',marginBottom:10,fontSize:13}} onClick={doPurchase} disabled={buying}>
            {buying?<span className="spin">‚ü≥</span>:`UNLOCK FOR ${UNLOCK_PRICE_LABEL}`}
          </button>
          <button className="gbtn gbtn-outline" style={{width:'100%',marginBottom:10,fontSize:11}} onClick={doRestore} disabled={restoring}>{restoring?'RESTORING...':'RESTORE PURCHASE'}</button>
          <button className="gbtn gbtn-outline" style={{width:'100%',fontSize:11}} onClick={()=>{audio.playClick();setShowPay(false);}}>MAYBE LATER</button>
          <div style={{fontSize:10,color:'#445566',marginTop:12}}>One-time ¬∑ No subscription ¬∑ Yours forever</div>
        </>}
      </div>
    </div>}

    {/* Main Game */}
    <div className="ng-root">
      <div className="wrap">

        {/* MENU */}
        {scr==='menu'&&<div className="fadein" style={{textAlign:'center'}}>
          <div style={{marginBottom:6}}><span className="orb" style={{fontSize:10,letterSpacing:6,color:'#4CC9F0',opacity:.7}}>COGNITIVE TRAINING</span></div>
          <h1 className="orb beat title" style={{fontSize:50,fontWeight:900,letterSpacing:4,lineHeight:1.05,background:'linear-gradient(135deg,#4CC9F0,#C77DFF,#FF4D6D)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',marginBottom:6}}>NEURO<br/>GRID</h1>
          <p style={{fontSize:14,color:'#8899bb',marginBottom:10,letterSpacing:1}}>Pattern Recognition ¬∑ Memory ¬∑ Speed</p>
          <div style={{marginBottom:20}}>{unlocked?<div className="unlock-badge">üëë FULL GAME UNLOCKED</div>:<span className="free-badge">‚úì FREE ‚Äî LEVELS 1‚Äì{FREE_LEVEL_LIMIT}</span>}</div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginBottom:22}}>
            {[['ADAPT','Evolves to your speed'],['LAYER','Rules build each level'],['TRACK','Cognitive progress']].map(([l,d])=>(
              <div key={l} className="scard"><div className="orb" style={{fontSize:9,color:'#4CC9F0',letterSpacing:2,marginBottom:3}}>{l}</div><div style={{fontSize:10,color:'#667799'}}>{d}</div></div>
            ))}
          </div>
          <div style={{marginBottom:18}}>
            <div style={{background:'rgba(255,255,255,.03)',borderRadius:12,padding:'12px 16px',textAlign:'left',fontSize:13,color:'#aabbd0',lineHeight:1.9}}>
              1. Study the glowing pattern on the grid<br/>
              2. Memorise numbered sequence &amp; colors<br/>
              3. Tap cells in the correct order from memory<br/>
              4. Faster = more points + streak bonus! üî•
            </div>
          </div>
          {best>0&&<div style={{marginBottom:14,color:'#FFD166'}} className="orb">BEST: {best.toLocaleString()}</div>}
          <button className="gbtn" onClick={startGame} style={{marginBottom:12}}>START GAME</button>
          {!unlocked&&<div>
            <button className="gbtn gbtn-gold" onClick={()=>{audio.playClick();setShowPay(true);}}>üëë UNLOCK FULL GAME ‚Äî {UNLOCK_PRICE_LABEL}</button>
            <div style={{fontSize:11,color:'#445566',marginTop:8}}>One-time ¬∑ No subscription ¬∑ Yours forever</div>
          </div>}
        </div>}

        {/* STUDY */}
        {scr==='study'&&pat&&<div className="fadein">
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
            <div><div style={{fontSize:10,color:'#667799',letterSpacing:2}}>LEVEL</div><div className="orb" style={{fontSize:26,fontWeight:900,color:'#4CC9F0'}}>{level}</div></div>
            <div style={{textAlign:'center'}}><div className="pulse orb" style={{fontSize:10,color:'#FFD166',letterSpacing:2}}>MEMORIZE</div><div className="orb" style={{fontSize:42,color:'#FFD166',fontWeight:900,textShadow:'0 0 24px #FFD16699'}}>{studyT}</div></div>
            <div style={{textAlign:'right'}}><div style={{fontSize:10,color:'#667799',letterSpacing:2}}>SCORE</div><div className="orb" style={{fontSize:20,fontWeight:700}}>{score.toLocaleString()}</div></div>
          </div>
          <div style={{marginBottom:10,fontSize:12,color:'#8899bb'}}>Memorise <strong style={{color:'#4CC9F0'}}>{pat.len}</strong> cells in order:</div>
          <div className="grid" style={{gridTemplateColumns:`repeat(${GRID_SIZE},1fr)`}}>
            {pat.cells.map((cell,idx)=>(
              <div key={idx} className="gcell" style={{...cs(cell,idx),cursor:'default'}}>
                {cell.isP&&<span style={{fontSize:16,fontWeight:900,color:GLOW[cell.ci],textShadow:`0 0 10px ${GLOW[cell.ci]}`,fontFamily:"'Orbitron',monospace"}}>{cell.ord+1}</span>}
              </div>
            ))}
          </div>
          <div className="hearts" style={{marginTop:12}}><Hearts/></div>
        </div>}

        {/* PLAY */}
        {scr==='play'&&pat&&<div className="fadein">
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}}>
            <div><div style={{fontSize:10,color:'#667799',letterSpacing:2}}>LEVEL</div><div className="orb" style={{fontSize:26,fontWeight:900,color:'#4CC9F0'}}>{level}</div></div>
            <div style={{textAlign:'center'}}><div style={{fontSize:10,color:'#667799',letterSpacing:2,marginBottom:2}}>PROGRESS</div><div className="orb" style={{fontSize:18}}>{sel.length}/{pat.len}</div></div>
            <div style={{textAlign:'right'}}><div style={{fontSize:10,color:'#667799',letterSpacing:2}}>SCORE</div><div className="orb" style={{fontSize:20,fontWeight:700}}>{score.toLocaleString()}</div></div>
          </div>
          <div className="tbar"><div className="tfill" style={{width:`${tLeft}%`,background:tLeft>50?'#4CC9F0':tLeft>25?'#FFD166':'#FF4D6D',boxShadow:`0 0 10px ${tLeft>50?'#4CC9F0':tLeft>25?'#FFD166':'#FF4D6D'}`}}/></div>
          {msg&&<div style={{textAlign:'center',fontSize:13,color:msg.includes('‚ùå')?'#FF4D6D':'#7BFF72',marginBottom:8,letterSpacing:1}}>{msg}</div>}
          <div className={shake?'shake grid':'grid'} style={{gridTemplateColumns:`repeat(${GRID_SIZE},1fr)`}}>
            {pat.cells.map((cell,idx)=>(
              <div key={idx} className="gcell" style={cs(cell,idx)} onClick={()=>cellClick(idx)}>
                {sel.includes(idx)&&<span style={{fontSize:13,fontWeight:900,color:GLOW[cell.ci],fontFamily:"'Orbitron',monospace"}}>{sel.indexOf(idx)+1}</span>}
              </div>
            ))}
          </div>
          <div style={{marginTop:12,display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <div className="hearts"><Hearts/></div>
            <div style={{display:'flex',gap:8,alignItems:'center'}}>
              {streak>1&&<div className="orb" style={{fontSize:12,color:'#FFD166'}}>üî• {streak}</div>}
              {!unlocked&&<button onClick={()=>triggerAd('hint')} style={{background:'rgba(76,201,240,.1)',border:'1px solid rgba(76,201,240,.3)',borderRadius:8,color:'#4CC9F0',fontSize:11,padding:'5px 10px',cursor:'pointer',fontFamily:"'Orbitron',monospace"}}>üí° HINT (AD)</button>}
            </div>
          </div>
        </div>}

        {/* RESULT */}
        {scr==='result'&&<div className="fadein" style={{textAlign:'center'}}>
          <div className="orb" style={{fontSize:38,fontWeight:900,color:'#7BFF72',textShadow:'0 0 30px #7BFF7288',marginBottom:4}}>CORRECT!</div>
          <div style={{fontSize:14,color:'#8899bb',marginBottom:20}}>{msg}</div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:16}}>
            <div className="scard"><div style={{fontSize:10,color:'#667799',letterSpacing:2,marginBottom:4}}>SCORE</div><div className="orb" style={{fontSize:26,fontWeight:900,color:'#4CC9F0'}}>{score.toLocaleString()}</div></div>
            <div className="scard"><div style={{fontSize:10,color:'#667799',letterSpacing:2,marginBottom:4}}>LEVEL</div><div className="orb" style={{fontSize:26,fontWeight:900,color:'#C77DFF'}}>{level}</div></div>
          </div>
          {!unlocked&&<div className="scard" style={{marginBottom:14}}>
            <div style={{fontSize:10,color:'#667799',letterSpacing:2,marginBottom:6}}>FREE LEVELS</div>
            <div className="lvl-bar"><div className="lvl-fill" style={{width:`${Math.min(100,(level/FREE_LEVEL_LIMIT)*100)}%`}}/></div>
            <div style={{fontSize:11,color:'#8899bb',marginTop:4}}>{level}/{FREE_LEVEL_LIMIT} free ¬∑ <span style={{color:'#FFD166'}}>Unlock all {UNLOCK_PRICE_LABEL}</span></div>
          </div>}
          <div className="scard" style={{marginBottom:20}}>
            <div style={{fontSize:10,color:'#667799',letterSpacing:2,marginBottom:8}}>üß† COGNITIVE SCORE</div>
            <div className="cbar"><div className="cfill" style={{width:`${cog}%`}}/></div>
            <div className="orb" style={{fontSize:12,color:'#4CC9F0',marginTop:6}}>{cog}%</div>
          </div>
          <button className="gbtn" onClick={tryNext} style={{marginBottom:10}}>{level+1>FREE_LEVEL_LIMIT&&!unlocked?'üëë UNLOCK TO CONTINUE':'NEXT LEVEL ‚Üí'}</button>
          {!unlocked&&level+1>FREE_LEVEL_LIMIT&&<div style={{fontSize:11,color:'#667799'}}>{UNLOCK_PRICE_LABEL} one-time ¬∑ All levels forever</div>}
        </div>}

        {/* GAME OVER */}
        {scr==='gameover'&&<div className="fadein" style={{textAlign:'center'}}>
          <div className="orb" style={{fontSize:10,letterSpacing:6,color:'#FF4D6D',marginBottom:8}}>SESSION COMPLETE</div>
          <h2 className="orb" style={{fontSize:44,fontWeight:900,background:'linear-gradient(135deg,#FF4D6D,#C77DFF)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',marginBottom:4}}>GAME<br/>OVER</h2>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:16,marginTop:16}}>
            {[['FINAL SCORE',score.toLocaleString(),'#4CC9F0'],['LEVEL REACHED',level,'#C77DFF'],['BEST STREAK',streak+'x','#FFD166'],['BEST SCORE',best.toLocaleString(),'#7BFF72']].map(([l,v,c])=>(
              <div key={l} className="scard"><div style={{fontSize:9,color:'#667799',letterSpacing:2,marginBottom:4}}>{l}</div><div className="orb" style={{fontSize:22,fontWeight:900,color:c}}>{v}</div></div>
            ))}
          </div>
          <div className="scard" style={{marginBottom:18}}>
            <div style={{fontSize:10,color:'#667799',letterSpacing:2,marginBottom:8}}>üß† COGNITIVE SCORE</div>
            <div className="cbar"><div className="cfill" style={{width:`${cog}%`}}/></div>
            <div className="orb" style={{fontSize:14,color:'#4CC9F0',marginTop:6}}>{cog}%</div>
            <div style={{fontSize:11,color:'#667799',marginTop:4}}>{cog>=70?'üåü Excellent neural performance!':cog>=40?'‚ö° Good pattern retention!':'üîÑ Keep training to improve!'}</div>
          </div>
          {!contUsed&&lives===0&&<button className="gbtn gbtn-green" style={{width:'100%',marginBottom:10}} onClick={()=>triggerAd('continue')}>üì∫ WATCH AD TO CONTINUE</button>}
          <div style={{display:'flex',gap:10,justifyContent:'center',marginBottom:10}}>
            <button className="gbtn" onClick={restart}>PLAY AGAIN</button>
            <button className="gbtn gbtn-outline" onClick={()=>{audio.playClick();setScr('menu');}}>MENU</button>
          </div>
          {!unlocked&&<button className="gbtn gbtn-gold" style={{width:'100%'}} onClick={()=>{audio.playClick();setShowPay(true);}}>üëë UNLOCK FULL GAME ‚Äî {UNLOCK_PRICE_LABEL}</button>}
        </div>}

      </div>
    </div>
  </>;
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<NeuroGrid/>);
</script>
</body>
</html>
